// backend/routes/Live.js
// World-Studio.live - Live Streaming Routes (UNIVERSE EDITION üåå)

const express = require("express");
const router = express.Router();
const auth = require("../middleware/auth");
const checkBan = require("../middleware/checkBan");
const Stream = require("../models/Stream");
const User = require("../models/User");

const PUBLIC_STREAM_FIELDS =
    "title description category thumbnailUrl roomId isLive status viewersCount viewers startedAt createdAt streamerId streamerName streamerAvatar";

const isObjectId = (id) => /^[0-9a-fA-F]{24}$/.test(id || "");

// ------------------------------------------------
// GET /api/live  -> lijst met alle live streams
// ------------------------------------------------
router.get("/", async (req, res) => {

    try {
        const streams = await Stream.find({
            isLive: true,
            status: { $in: ["live", "scheduled"] },
        })
            .sort({ viewersCount: -1, createdAt: -1 })
            .select(PUBLIC_STREAM_FIELDS)
            .lean();

        return res.json(streams);
    } catch (err) {
        console.error("‚ùå [GET /api/live] error:", err);
        return res.status(500).json({ error: "Failed to load live streams" });
    }
});

// alias /api/live/discover
router.get("/discover", async (req, res) => {
    req.url = "/";
    return router.handle(req, res);
});

// ------------------------------------------------
// POST /api/live/start  -> start stream
// body: { title?, description?, category?, thumbnailUrl?, roomId? }
// ------------------------------------------------
router.post("/start", auth, checkBan, async (req, res) => {
    try {
        const userId = req.user.id;
        const {
            title = "Live stream",
            description = "",
            category = "general",
            thumbnailUrl = "",
            roomId,
        } = req.body;

        const user = await User.findById(userId).select("username avatar isBanned isDeactivated");
        if (!user || user.isBanned || user.isDeactivated) {
            return res.status(400).json({ error: "User not allowed to stream" });
        }

        let stream = await Stream.findOne({
            streamerId: userId,
            isLive: true,
            status: { $in: ["live", "scheduled"] },
        });

        const now = new Date();
        const room = roomId || (stream ? stream.roomId : undefined) || userId.toString();

        if (!stream) {
            stream = new Stream({
                title,
                description,
                category,
                thumbnailUrl,
                streamerId: userId,
                streamerName: user.username,
                streamerAvatar: user.avatar,
                roomId: room,
                isLive: true,
                status: "live",
                viewers: [],
                viewersCount: 0,
                startedAt: now,
            });
        } else {
            stream.title = title;
            stream.description = description;
            stream.category = category;
            stream.thumbnailUrl = thumbnailUrl;
            stream.roomId = room;
            stream.isLive = true;
            stream.status = "live";
            stream.startedAt = stream.startedAt || now;
        }

        await stream.save();


        user.isLive = true;
        user.currentStreamId = stream._id;
        user.lastStreamedAt = now;
        await user.save();

        return res.json({
            success: true,
            streamId: stream._id,
            roomId: stream.roomId || stream._id.toString(),
            stream,
        });
    } catch (err) {
        console.error("‚ùå [POST /api/live/start] error:", err);
        return res.status(500).json({ error: "Failed to start live stream" });
    }
});

// ------------------------------------------------
// POST /api/live/stop/:id  -> stop stream
// ------------------------------------------------
router.post("/stop/:id", auth, checkBan, async (req, res) => {
    try {
        const userId = req.user.id;
        const param = req.params.id;

        const stream = await Stream.findOne({
            $or: [
                { _id: isObjectId(param) ? param : undefined },
                { roomId: param },
            ].filter((q) => q._id || q.roomId),
        });

        if (!stream) {
            return res.status(404).json({ error: "Stream not found" });
        }
        if (stream.streamerId.toString() !== userId.toString()) {
            return res.status(403).json({ error: "Not allowed to stop this stream" });
        }

        stream.isLive = false;
        stream.status = "ended";
        stream.endedAt = new Date();
        await stream.save();

        await User.updateOne(
            { _id: userId },
            {
                $set: {
                    isLive: false,
                    currentStreamId: null,
                    lastStreamedAt: new Date(),
                },
            }
        );

        return res.json({ success: true });
    } catch (err) {
        console.error("‚ùå [POST /api/live/stop/:id] error:", err);
        return res.status(500).json({ error: "Failed to stop live stream" });
    }
});

// ------------------------------------------------
// GET /api/live/user/:userId/status -> user's live status
// Returns whether user is live and their current stream info
// ‚ö†Ô∏è MUST be BEFORE /:id route!
// ------------------------------------------------
router.get("/user/:userId/status", async (req, res) => {
    try {
        const { userId } = req.params;

        // Validate userId format
        if (!isObjectId(userId)) {
            return res.status(400).json({
                success: false,
                error: "Invalid user ID format"
            });
        }

        // Check if user exists and get their live status
        const user = await User.findById(userId)
            .select("isLive currentStreamId username avatar isVerified")
            .lean();

        if (!user) {
            return res.status(404).json({
                success: false,
                error: "User not found"
            });
        }

        // If user is live, get their stream info
        let stream = null;
        if (user.isLive && user.currentStreamId) {
            stream = await Stream.findById(user.currentStreamId)
                .select("title category roomId viewersCount thumbnailUrl startedAt status")
                .lean();
        }

        // Fallback: check for any active stream by this user
        if (!stream && user.isLive) {
            stream = await Stream.findOne({
                streamerId: userId,
                isLive: true,
                status: { $in: ["live", "scheduled"] }
            })
                .select("title category roomId viewersCount thumbnailUrl startedAt status")
                .lean();
        }

        // Double-check: if we found no stream, user shouldn't be marked as live
        const actuallyLive = user.isLive && !!stream;

        // Optionally fix inconsistent state (user marked live but no stream)
        if (user.isLive && !stream) {
            await User.updateOne(
                { _id: userId },
                { $set: { isLive: false, currentStreamId: null } }
            );
        }

        return res.json({
            success: true,
            isLive: actuallyLive,
            user: {
                _id: user._id,
                username: user.username,
                avatar: user.avatar,
                isVerified: user.isVerified
            },
            stream: stream ? {
                _id: stream._id,
                title: stream.title,
                category: stream.category,
                roomId: stream.roomId,
                viewers: stream.viewersCount || 0,
                thumbnailUrl: stream.thumbnailUrl,
                startedAt: stream.startedAt,
                status: stream.status
            } : null
        });
    } catch (err) {
        console.error("‚ùå [GET /api/live/user/:userId/status] error:", err);
        return res.status(500).json({
            success: false,
            error: "Failed to get user status"
        });
    }
});

// ------------------------------------------------
// GET /api/live/user/:userId/history -> user's stream history
// ------------------------------------------------
router.get("/user/:userId/history", async (req, res) => {
    try {
        const { userId } = req.params;
        const { page = 1, limit = 20 } = req.query;

        if (!isObjectId(userId)) {
            return res.status(400).json({
                success: false,
                error: "Invalid user ID format"
            });
        }

        const skip = (parseInt(page) - 1) * parseInt(limit);

        const [streams, total] = await Promise.all([
            Stream.find({ streamerId: userId })
                .sort({ startedAt: -1 })
                .skip(skip)
                .limit(parseInt(limit))
                .select("title category roomId viewersCount peakViewers thumbnailUrl startedAt endedAt status duration")
                .lean(),
            Stream.countDocuments({ streamerId: userId })
        ]);

        return res.json({
            success: true,
            streams,
            pagination: {
                page: parseInt(page),
                limit: parseInt(limit),
                total,
                pages: Math.ceil(total / parseInt(limit))
            }
        });
    } catch (err) {
        console.error("‚ùå [GET /api/live/user/:userId/history] error:", err);
        return res.status(500).json({
            success: false,
            error: "Failed to get stream history"
        });
    }
});

// ------------------------------------------------
// GET /api/live/:id  -> stream details (id of roomId)
// ‚ö†Ô∏è MUST be LAST - catches all other params!
// ------------------------------------------------
router.get("/:id", async (req, res) => {
    try {
        const param = req.params.id;

        const stream = await Stream.findOne({
            $or: [
                { _id: isObjectId(param) ? param : undefined },
                { roomId: param },
            ].filter((q) => q._id || q.roomId),
        })
            .populate("streamerId", "username avatar isVerified")
            .lean();

        if (!stream) {
            return res.status(404).json({ error: "Stream not found" });
        }

        return res.json(stream);
    } catch (err) {
        console.error("‚ùå [GET /api/live/:id] error:", err);
        return res.status(500).json({ error: "Failed to load stream" });
    }
});


module.exports = router;
